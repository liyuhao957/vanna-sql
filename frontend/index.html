<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vanna SQL ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="/frontend/style.css">
    <style>
        body {
            background: linear-gradient(135deg, #e8f0fe 0%, #e0f7fa 100%);
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', Arial, sans-serif;
        }
        .container {
            max-width: 1280px;
            margin-top: 48px;
        }
        h2 {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 2.5rem;
            color: #263159;
            text-shadow: 0 2px 8px #e3eafc;
        }
        .main-flex {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 3.5rem;
            margin-bottom: 2.5rem;
        }
        .card {
            border-radius: 22px;
            box-shadow: 0 8px 32px 0 rgba(60,72,88,0.13);
            border: none;
            background: #fff;
            margin-bottom: 2rem;
            min-width: 400px;
            max-width: 520px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        .card-header {
            border-radius: 22px 22px 0 0;
            font-size: 1.18rem;
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #1976d2 60%, #26c6da 100%);
            color: #fff;
            text-align: left;
            padding: 1.1rem 1.5rem;
        }
        .card-body {
            padding: 2rem 1.5rem 1.5rem 1.5rem;
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .btn {
            border-radius: 10px;
            font-weight: 500;
            font-size: 1.08rem;
            transition: background 0.18s, color 0.18s, box-shadow 0.18s;
        }
        .btn-outline-primary {
            border-width: 2px;
            color: #1976d2;
            border-color: #1976d2;
            background: #f4faff;
        }
        .btn-outline-primary:hover {
            background: #1976d2;
            color: #fff;
            box-shadow: 0 2px 8px #1976d2a0;
        }
        .btn-primary {
            background: #1976d2;
            border-color: #1976d2;
        }
        .btn-primary:hover {
            background: #1251a3;
            border-color: #1251a3;
        }
        #training-data-list {
            margin-top: 1.2rem;
            min-height: 320px;
            max-height: 540px;
            overflow-y: auto;
        }
        .training-card {
            position: relative;
            background: #fafdff;
            border-radius: 16px;
            box-shadow: 0 2px 8px 0 rgba(60,72,88,0.08);
            margin-bottom: 1.5rem;
            padding: 0 0 0.5rem 0;
            transition: box-shadow 0.2s;
            border: 1.5px solid #e3eafc;
        }
        .training-card:hover {
            box-shadow: 0 8px 24px 0 rgba(60,72,88,0.18);
            border-color: #b6d0f7;
        }
        .training-card .btn-danger {
            position: absolute;
            top: 14px;
            right: 20px;
            z-index: 2;
            float: none;
            margin-top: 0;
            padding: 0.28rem 1.1rem;
            font-size: 1rem;
            border-radius: 18px;
            background: #e53935;
            border: none;
            font-weight: 600;
            letter-spacing: 1px;
            box-shadow: 0 2px 8px #e5393530;
        }
        .training-card .btn-danger:hover {
            background: #b71c1c;
            color: #fff;
        }
        .training-card .card-content {
            padding: 1.3rem 1.3rem 0.7rem 1.3rem;
            overflow-x: hidden;
            word-break: break-all;
            white-space: pre-line;
            font-size: 1.08rem;
            color: #263159;
            line-height: 1.7;
        }
        .training-card b {
            color: #1976d2;
            font-weight: 700;
        }
        .training-card span {
            color: #374151;
        }
        textarea.form-control {
            font-size: 1.08rem;
            line-height: 1.7;
            min-height: 80px;
            resize: vertical;
        }
        @media (max-width: 1200px) {
            .container { max-width: 99vw; }
            .main-flex { gap: 1.2rem; }
        }
        @media (max-width: 900px) {
            .container { max-width: 100vw; }
            .main-flex { flex-direction: column; align-items: stretch; gap: 2rem; }
            .card { min-width: unset; max-width: 100vw; }
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h2 class="mb-4 text-center">Vanna SQL ç”Ÿæˆå™¨
        <button class="btn btn-outline-secondary btn-sm float-end" style="position:absolute;right:40px;top:32px;" onclick="showFeedbackHistory()">åé¦ˆå†å²</button>
    </h2>
    <div class="main-flex">
        <div class="col-md-5">
            <div class="card">
                <div class="card-header bg-primary text-white">è®­ç»ƒæ•°æ®æŸ¥çœ‹</div>
                <div class="card-body">
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="loadTrainingData()">æŸ¥çœ‹è®­ç»ƒæ•°æ®</button>
                    <div id="training-data-list"></div>
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card">
                <div class="card-header bg-success text-white">SQLç”Ÿæˆ</div>
                <div class="card-body">
                    <form id="sql-form" method="post">
                        <div class="mb-3">
                            <label for="question" class="form-label">è¯·è¾“å…¥æ‚¨çš„è‡ªç„¶è¯­è¨€é—®é¢˜ï¼š</label>
                            <textarea class="form-control mb-2" name="question" id="question" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" id="generate-btn">ç”ŸæˆSQL</button>
                        <span id="loading-indicator" style="display:none; margin-left:10px; color:#007bff; font-weight:bold;">ç”Ÿæˆä¸­...</span>
                    </form>
                    <div id="result" class="mt-4"></div>
                    <div id="feedback-buttons" style="display:none; margin-top: 10px;">
                        <button class="btn btn-success me-2" onclick="sendFeedback('correct')">ç»“æœæ­£ç¡®</button>
                        <button class="btn btn-danger" onclick="showCorrectionBox()">ç»“æœé”™è¯¯</button>
                    </div>
                    <!-- æ–°å¢SQLä¿®æ­£TabåŒº -->
                    <ul class="nav nav-tabs mt-4" id="fixTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="auto-tab" data-bs-toggle="tab" data-bs-target="#auto-fix" type="button" role="tab">è‡ªåŠ¨ä¿®æ­£</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-fix" type="button" role="tab">æ‰‹åŠ¨ä¿®æ­£</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="optimize-tab" data-bs-toggle="tab" data-bs-target="#optimize-fix" type="button" role="tab">ç»“æœä¼˜åŒ–</button>
                        </li>
                    </ul>
                    <div class="tab-content border border-top-0 rounded-bottom p-4 bg-light" id="fixTabContent" style="min-height:260px;">
                        <!-- è‡ªåŠ¨ä¿®æ­£ -->
                        <div class="tab-pane fade show active" id="auto-fix" role="tabpanel">
                            <div class="mb-3">
                                <label for="auto-error-message" class="form-label">è¯·è¾“å…¥æ•°æ®åº“æŠ¥é”™ä¿¡æ¯ï¼š</label>
                                <textarea class="form-control" id="auto-error-message" rows="3" placeholder="ç²˜è´´æ•°æ®åº“æŠ¥é”™ä¿¡æ¯"></textarea>
                            </div>
                            <button class="btn btn-primary" id="auto-fix-btn">ä¿®æ­£SQL</button>
                            <span id="auto-fix-loading" style="display:none; margin-left:10px; color:#1976d2; font-weight:bold;">ä¿®æ­£ä¸­...</span>
                            <div id="auto-fix-result" class="mt-3"></div>
                        </div>
                        <!-- æ‰‹åŠ¨ä¿®æ­£ -->
                        <div class="tab-pane fade" id="manual-fix" role="tabpanel">
                            <div class="mb-3">
                                <label for="manual-sql" class="form-label">è¯·è¾“å…¥åŸå§‹SQLï¼š</label>
                                <textarea class="form-control mb-2" id="manual-sql" rows="3" placeholder="ç²˜è´´éœ€è¦ä¿®æ­£çš„SQL"></textarea>
                                <label for="manual-error-message" class="form-label">è¯·è¾“å…¥æ•°æ®åº“æŠ¥é”™ä¿¡æ¯ï¼š</label>
                                <textarea class="form-control" id="manual-error-message" rows="3" placeholder="ç²˜è´´æ•°æ®åº“æŠ¥é”™ä¿¡æ¯"></textarea>
                            </div>
                            <button class="btn btn-primary" id="manual-fix-btn">ä¿®æ­£SQL</button>
                            <span id="manual-fix-loading" style="display:none; margin-left:10px; color:#1976d2; font-weight:bold;">ä¿®æ­£ä¸­...</span>
                            <div id="manual-fix-result" class="mt-3"></div>
                        </div>
                        <!-- ç»“æœä¸ç¬¦æ—¶çš„SQLä¼˜åŒ– -->
                        <div class="tab-pane fade" id="optimize-fix" role="tabpanel">
                            <div class="mb-3">
                                <label for="opt-sql" class="form-label">åŸå§‹SQLï¼š</label>
                                <textarea class="form-control mb-2" id="opt-sql" rows="3" placeholder="è‡ªåŠ¨å¡«å……æˆ–ç²˜è´´åŸå§‹SQL"></textarea>
                                <label for="opt-result" class="form-label">å®é™…æŸ¥è¯¢ç»“æœï¼ˆå¯é€‰ï¼‰ï¼š</label>
                                <textarea class="form-control mb-2" id="opt-result" rows="3" placeholder="å¯ç²˜è´´éƒ¨åˆ†æŸ¥è¯¢ç»“æœæˆ–ç•™ç©º"></textarea>
                                <label for="opt-intent" class="form-label">çœŸå®éœ€æ±‚æè¿°ï¼ˆå¿…å¡«ï¼‰ï¼š</label>
                                <textarea class="form-control" id="opt-intent" rows="3" placeholder="è¯·æè¿°ä½ æƒ³è¦çš„ç»“æœï¼Œä¾‹å¦‚ï¼šæ¯ä¸ªçœä»½çš„ç”¨æˆ·æ•°"></textarea>
                            </div>
                            <button class="btn btn-primary" id="optimize-fix-btn">ä¼˜åŒ–SQL</button>
                            <span id="optimize-fix-loading" style="display:none; margin-left:10px; color:#1976d2; font-weight:bold;">ä¼˜åŒ–ä¸­...</span>
                            <div id="optimize-fix-result" class="mt-3"></div>
                        </div>
                    </div>
                    <!-- ç»“æŸSQLä¿®æ­£TabåŒº -->
                    <!-- é”™è¯¯ä¿®æ­£å¼¹çª— -->
                    <div id="correction-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; box-shadow:0 2px 16px #1976d2a0; border-radius:10px; padding:24px 28px; z-index:10000; min-width:320px;">
                        <h5 style="margin-bottom:10px;">è¯·ä¿®æ­£SQLåæäº¤ï¼š</h5>
                        <textarea id="corrected-sql" class="form-control mb-3" rows="6"></textarea>
                        <div class="text-end">
                            <button class="btn btn-primary me-2" onclick="sendFeedback('incorrect')">æäº¤ä¿®æ­£</button>
                            <button class="btn btn-secondary" onclick="closeCorrectionBox()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- æ–°å¢ï¼šè§„åˆ™ç®¡ç†åŒºç‹¬ç«‹å—ï¼Œæ”¾åœ¨ä¸»å†…å®¹åŒºä¸‹æ–¹ -->
    <div class="rules-section mt-5 mb-4">
        <h4 class="mb-3" style="font-weight:700;color:#1976d2;">ä¸šåŠ¡è§„åˆ™ç®¡ç†</h4>
        <div class="mb-3">
            <label for="rule-type" class="form-label">è§„åˆ™ç±»å‹ï¼š</label>
            <select class="form-select mb-2" id="rule-type">
                <option value="å®½è¡¨åˆ†åŒºè¿‡æ»¤">å®½è¡¨åˆ†åŒºè¿‡æ»¤ï¼ˆå¦‚WHERE/JOINå¿…é¡»å«timedï¼‰</option>
                <option value="å¤§è¡¨ORDER BYé™åˆ¶">å¤§è¡¨ORDER BYé™åˆ¶</option>
                <option value="ç¦æ­¢å…¨è¡¨æ‰«æ">ç¦æ­¢å…¨è¡¨æ‰«æ</option>
                <option value="JOINåˆ†åŒºå­—æ®µ">JOINåˆ†åŒºå­—æ®µ</option>
                <option value="çª—å£å‡½æ•°æ¨è">çª—å£å‡½æ•°æ¨è</option>
                <option value="CTEæ¨è">CTEæ¨è</option>
                <option value="å¤æ‚æŸ¥è¯¢ä¼˜åŒ–">å¤æ‚æŸ¥è¯¢ä¼˜åŒ–</option>
                <option value="JOINé¡ºåºä¼˜åŒ–">JOINé¡ºåºä¼˜åŒ–</option>
                <option value="è¡Œè½¬åˆ—æ¨è">è¡Œè½¬åˆ—æ¨è</option>
                <option value="åˆ†é¡µä¼˜åŒ–">åˆ†é¡µä¼˜åŒ–</option>
                <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰</option>
            </select>
            <label for="rule-tables" class="form-label">è¡¨å/å­—æ®µå/å†…å®¹ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰ï¼š</label>
            <input type="text" class="form-control mb-2" id="rule-tables" placeholder="å¦‚ large_table, fact_table, timed ...">
            <label for="rule-partition" class="form-label">åˆ†åŒºå­—æ®µï¼ˆå¦‚æœ‰ï¼‰ï¼š</label>
            <input type="text" class="form-control mb-2" id="rule-partition" placeholder="å¦‚ timed">
            <label for="rule-forbid-order" class="form-label">ç¦æ­¢ORDER BYï¼ˆä»…éƒ¨åˆ†è§„åˆ™ç±»å‹é€‚ç”¨ï¼‰ï¼š</label>
            <select class="form-select mb-2" id="rule-forbid-order">
                <option value="">-- è¯·é€‰æ‹© --</option>
                <option value="true">æ˜¯</option>
                <option value="false">å¦</option>
            </select>
            <label for="rule-other" class="form-label">å…¶ä»–å†…å®¹ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="text" class="form-control mb-2" id="rule-other" placeholder="å¦‚çª—å£å‡½æ•°åã€ä¼˜åŒ–å»ºè®®ç­‰">
            <button class="btn btn-primary mt-2" id="add-rule-btn">æ–°å¢è§„åˆ™</button>
        </div>
        <hr>
        <div id="rules-list">åŠ è½½ä¸­...</div>
    </div>
</div>
<div id="toast" style="
    display:none;
    position: fixed;
    bottom: 40px;
    right: 40px;
    min-width: 180px;
    background: #1976d2;
    color: #fff;
    padding: 14px 28px;
    border-radius: 8px;
    box-shadow: 0 2px 12px #1976d2a0;
    font-size: 1.08rem;
    z-index: 9999;
    text-align: center;
    opacity: 0.95;
    transition: opacity 0.3s;
"></div>
<!-- åé¦ˆå†å²å¼¹çª— -->
<div id="feedback-history-modal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; box-shadow:0 2px 16px #1976d2a0; border-radius:10px; padding:24px 28px; z-index:10001; min-width:520px; max-height:80vh; overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h5 style="margin:0;">åé¦ˆå†å²</h5>
        <button class="btn btn-sm btn-secondary" onclick="closeFeedbackHistory()">å…³é—­</button>
    </div>
    <div id="feedback-history-list">åŠ è½½ä¸­...</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// è®­ç»ƒæ•°æ®æäº¤ç›¸å…³ä»£ç å·²ç§»é™¤
// åŠ è½½è®­ç»ƒæ•°æ®
async function loadTrainingData() {
    const list = document.getElementById('training-data-list');
    list.innerHTML = 'åŠ è½½ä¸­...';
    const res = await fetch('/api/training_data');
    const data = await res.json();
    if(data.success) {
        if(data.data.length === 0) { list.innerHTML = 'æš‚æ— è®­ç»ƒæ•°æ®'; return; }
        list.innerHTML = data.data.map(item =>
            `<div class='border rounded p-2 mb-1 small training-card'>
                <button class='btn btn-danger btn-sm mt-1' onclick='deleteTrainingData("${item.id}")'><span class='icon-trash'>ğŸ—‘ï¸</span>åˆ é™¤</button>
                <div class='card-content'>
                    <b>ID:</b> ${item.id || ''}<br>
                    <b>ç±»å‹:</b> ${item.training_data_type || ''}<br>
                    <b>é—®é¢˜:</b> ${item.question || ''}<br>
                    <b>SQL:</b> <span style='white-space:pre-line;'>${item.content || ''}</span><br>
                </div>
            </div>`
        ).join('');
    } else {
        list.innerHTML = 'åŠ è½½å¤±è´¥ï¼š' + data.msg;
    }
}
// åˆ é™¤è®­ç»ƒæ•°æ®
async function deleteTrainingData(id) {
    if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®­ç»ƒæ•°æ®å—ï¼Ÿ')) return;
    const formData = new FormData();
    formData.append('id', id);
    const res = await fetch('/api/delete_training_data', {method:'POST', body:formData});
    const data = await res.json();
    alert(data.msg);
    loadTrainingData();
}
// SQLç”Ÿæˆ
// åªä¿ç•™å”¯ä¸€çš„äº‹ä»¶ç»‘å®š

document.addEventListener('DOMContentLoaded', function() {
    loadTrainingData();
    loadRules();
    const form = document.getElementById('sql-form');
    const loadingIndicator = document.getElementById('loading-indicator');
    const resultDiv = document.getElementById('result');
    const generateBtn = document.getElementById('generate-btn');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        loadingIndicator.style.display = 'inline';
        generateBtn.disabled = true;
        resultDiv.innerHTML = '';
        document.getElementById('feedback-buttons').style.display = 'none';
        const formData = new FormData(form);
        try {
            const response = await fetch('/api/generate_sql', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.success) {
                resultDiv.innerHTML = `<label class="form-label">ç”Ÿæˆçš„SQLï¼š</label>
                    <pre id="sql-output" class="bg-light p-2 rounded">${data.sql}</pre>
                    <button class="btn btn-outline-secondary btn-sm" onclick="copySQL()">ä¸€é”®å¤åˆ¶</button>`;
                document.getElementById('feedback-buttons').style.display = 'block';
            } else {
                resultDiv.innerHTML = `<span style="color:red;">${data.msg}</span>`;
            }
        } catch (error) {
            resultDiv.innerHTML = '<span style="color:red;">è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</span>';
        } finally {
            loadingIndicator.style.display = 'none';
            generateBtn.disabled = false;
        }
    });
});
// ä¸€é”®å¤åˆ¶
function copySQL() {
    const sql = document.getElementById('sql-output').innerText;
    navigator.clipboard.writeText(sql);
    showToast('SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
}

function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.innerText = msg;
    toast.style.display = 'block';
    toast.style.opacity = '0.95';
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => { toast.style.display = 'none'; }, 300);
    }, 1500);
}

function sendFeedback(type) {
    const question = document.getElementById('question').value;
    let sql = document.getElementById('sql-output').innerText;
    let feedback_type = type;
    if (type === 'incorrect') {
        sql = document.getElementById('corrected-sql').value;
    }
    fetch('/api/feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({question, sql, feedback_type})
    }).then(res => res.json()).then(data => {
        showToast(data.msg || 'åé¦ˆå·²ä¿å­˜ï¼Œç³»ç»Ÿå·²å­¦ä¹ ');
        closeCorrectionBox();
        document.getElementById('feedback-buttons').style.display = 'none';
    });
}
function showCorrectionBox() {
    document.getElementById('correction-modal').style.display = 'block';
    document.getElementById('corrected-sql').value = document.getElementById('sql-output').innerText;
}
function closeCorrectionBox() {
    document.getElementById('correction-modal').style.display = 'none';
}
function showFeedbackHistory() {
    const modal = document.getElementById('feedback-history-modal');
    const listDiv = document.getElementById('feedback-history-list');
    modal.style.display = 'block';
    listDiv.innerHTML = 'åŠ è½½ä¸­...';
    fetch('/api/feedback_history').then(res => res.json()).then(data => {
        if (!data.success) {
            listDiv.innerHTML = '<span style="color:red;">åŠ è½½å¤±è´¥ï¼š'+data.msg+'</span>';
            return;
        }
        if (!data.data || data.data.length === 0) {
            listDiv.innerHTML = 'æš‚æ— åé¦ˆè®°å½•';
            return;
        }
        let html = `<div class='feedback-card-list'>`;
        data.data.forEach(item => {
            html += `<div class='feedback-card'>
                <div class='feedback-main'>
                    <div class='feedback-question' title='${item.question ? item.question.replace(/'/g, "&apos;") : ''}'>${item.question ? item.question : ''}</div>
                    <div class='feedback-sql' title='${item.sql ? item.sql.replace(/'/g, "&apos;") : ''}'>${item.sql ? item.sql : ''}</div>
                </div>
                <div class='feedback-meta'>
                    <span class='feedback-type'>${item.type || ''}</span>
                    <span class='feedback-time' data-time='${item.time || ''}'>${item.time ? item.time.replace('T',' ').replace(/\..*$/, '') : ''}</span>
                    <button class='btn btn-danger btn-sm' onclick="deleteFeedback('${item.time}')"><span class='icon-trash'>ğŸ—‘ï¸</span>æ’¤é”€</button>
                </div>
            </div>`;
        });
        html += '</div>';
        listDiv.innerHTML = html;
        // æ—¶é—´å‹å¥½åŒ–
        document.querySelectorAll('.feedback-time').forEach(function(span){
            const t = span.getAttribute('data-time');
            if(t){
                span.innerText = friendlyTime(t);
            }
        });
    });
}
function closeFeedbackHistory() {
    document.getElementById('feedback-history-modal').style.display = 'none';
}
function deleteFeedback(time) {
    if (!confirm('ç¡®å®šè¦æ’¤é”€è¿™æ¡åé¦ˆå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
    fetch('/api/delete_feedback', {
        method: 'POST',
        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
        body: new URLSearchParams({time})
    }).then(res => res.json()).then(data => {
        showToast(data.msg || 'åé¦ˆå·²æ’¤é”€');
        showFeedbackHistory(); // åˆ·æ–°åˆ—è¡¨
    });
}
// SQLä¿®æ­£TabåŠŸèƒ½
// è‡ªåŠ¨ä¿®æ­£
const autoFixBtn = document.getElementById('auto-fix-btn');
const autoFixLoading = document.getElementById('auto-fix-loading');
const autoFixResult = document.getElementById('auto-fix-result');
autoFixBtn.onclick = async function() {
    const errorMsg = document.getElementById('auto-error-message').value.trim();
    if (!errorMsg) { showToast('è¯·å¡«å†™æŠ¥é”™ä¿¡æ¯'); return; }
    autoFixLoading.style.display = 'inline';
    autoFixBtn.disabled = true;
    autoFixResult.innerHTML = '';
    try {
        const formData = new FormData();
        formData.append('error_message', errorMsg);
        const res = await fetch('/api/fix_sql_auto', {method:'POST', body:formData});
        const data = await res.json();
        if (data.success) {
            autoFixResult.innerHTML = `<label class='form-label'>ä¿®æ­£åçš„SQLï¼š</label><pre id='auto-fixed-sql' class='bg-white p-2 rounded'>${data.fixed_sql}</pre><button class='btn btn-outline-secondary btn-sm' onclick='copyAutoFixedSQL()'>ä¸€é”®å¤åˆ¶</button>`;
        } else {
            autoFixResult.innerHTML = `<span style='color:red;'>${data.msg}</span>`;
        }
    } catch (e) {
        autoFixResult.innerHTML = '<span style="color:red;">è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</span>';
    } finally {
        autoFixLoading.style.display = 'none';
        autoFixBtn.disabled = false;
    }
};
function copyAutoFixedSQL() {
    const sql = document.getElementById('auto-fixed-sql').innerText;
    navigator.clipboard.writeText(sql);
    showToast('ä¿®æ­£åçš„SQLå·²å¤åˆ¶ï¼');
}
// æ‰‹åŠ¨ä¿®æ­£
const manualFixBtn = document.getElementById('manual-fix-btn');
const manualFixLoading = document.getElementById('manual-fix-loading');
const manualFixResult = document.getElementById('manual-fix-result');
manualFixBtn.onclick = async function() {
    const sql = document.getElementById('manual-sql').value.trim();
    const errorMsg = document.getElementById('manual-error-message').value.trim();
    if (!sql || !errorMsg) { showToast('è¯·å¡«å†™SQLå’ŒæŠ¥é”™ä¿¡æ¯'); return; }
    manualFixLoading.style.display = 'inline';
    manualFixBtn.disabled = true;
    manualFixResult.innerHTML = '';
    try {
        const formData = new FormData();
        formData.append('sql', sql);
        formData.append('error_message', errorMsg);
        const res = await fetch('/api/fix_sql_manual', {method:'POST', body:formData});
        const data = await res.json();
        if (data.success) {
            manualFixResult.innerHTML = `<label class='form-label'>ä¿®æ­£åçš„SQLï¼š</label><pre id='manual-fixed-sql' class='bg-white p-2 rounded'>${data.fixed_sql}</pre><button class='btn btn-outline-secondary btn-sm' onclick='copyManualFixedSQL()'>ä¸€é”®å¤åˆ¶</button>`;
        } else {
            manualFixResult.innerHTML = `<span style='color:red;'>${data.msg}</span>`;
        }
    } catch (e) {
        manualFixResult.innerHTML = '<span style="color:red;">è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</span>';
    } finally {
        manualFixLoading.style.display = 'none';
        manualFixBtn.disabled = false;
    }
};
function copyManualFixedSQL() {
    const sql = document.getElementById('manual-fixed-sql').innerText;
    navigator.clipboard.writeText(sql);
    showToast('ä¿®æ­£åçš„SQLå·²å¤åˆ¶ï¼');
}
// ç»“æœä¸ç¬¦æ—¶çš„SQLä¼˜åŒ–TabåŠŸèƒ½
const optimizeFixBtn = document.getElementById('optimize-fix-btn');
const optimizeFixLoading = document.getElementById('optimize-fix-loading');
const optimizeFixResult = document.getElementById('optimize-fix-result');
const optSqlTextarea = document.getElementById('opt-sql');
// è‡ªåŠ¨å¡«å……åŸå§‹SQLä¸ºæœ€è¿‘ä¸€æ¬¡ç”Ÿæˆçš„SQL
function fillOptSqlWithLast() {
    const sqlOutput = document.getElementById('sql-output');
    if (sqlOutput) {
        optSqlTextarea.value = sqlOutput.innerText;
    }
}
document.getElementById('optimize-tab').addEventListener('click', fillOptSqlWithLast);
optimizeFixBtn.onclick = async function() {
    const sql = optSqlTextarea.value.trim();
    const result = document.getElementById('opt-result').value.trim();
    const intent = document.getElementById('opt-intent').value.trim();
    if (!sql) { showToast('è¯·å¡«å†™åŸå§‹SQL'); return; }
    if (!intent) { showToast('è¯·å¡«å†™çœŸå®éœ€æ±‚æè¿°'); return; }
    optimizeFixLoading.style.display = 'inline';
    optimizeFixBtn.disabled = true;
    optimizeFixResult.innerHTML = '';
    try {
        const formData = new FormData();
        formData.append('original_sql', sql);
        formData.append('query_result', result);
        formData.append('user_intent', intent);
        const res = await fetch('/api/optimize_sql_with_rag', {method:'POST', body:formData});
        const data = await res.json();
        if (data.success) {
            optimizeFixResult.innerHTML = `<label class='form-label'>ä¼˜åŒ–åçš„SQLï¼š</label><pre id='optimize-fixed-sql' class='bg-white p-2 rounded'>${data.optimized_sql}</pre><button class='btn btn-outline-secondary btn-sm' onclick='copyOptimizeFixedSQL()'>ä¸€é”®å¤åˆ¶</button>`;
        } else {
            optimizeFixResult.innerHTML = `<span style='color:red;'>${data.msg}</span>`;
        }
    } catch (e) {
        optimizeFixResult.innerHTML = '<span style="color:red;">è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</span>';
    } finally {
        optimizeFixLoading.style.display = 'none';
        optimizeFixBtn.disabled = false;
    }
};
function copyOptimizeFixedSQL() {
    const sql = document.getElementById('optimize-fixed-sql').innerText;
    navigator.clipboard.writeText(sql);
    showToast('ä¼˜åŒ–åçš„SQLå·²å¤åˆ¶ï¼');
}
// è§„åˆ™ç®¡ç†TabåŠŸèƒ½
const rulesListDiv = document.getElementById('rules-list');
function ruleToDescription(rule) {
    if (rule.type === 'å®½è¡¨åˆ†åŒºè¿‡æ»¤') {
        return `æŸ¥è¯¢${(rule.tables||[]).join('æˆ–')}æ—¶ï¼Œå¿…é¡»åŠ ${rule.partition_field||'åˆ†åŒºå­—æ®µ'}è¿‡æ»¤æ¡ä»¶`;
    }
    if (rule.type === 'å¤§è¡¨ORDER BYé™åˆ¶') {
        return `æŸ¥è¯¢${(rule.tables||[]).join('æˆ–')}æ—¶ç¦æ­¢ä½¿ç”¨ORDER BY`;
    }
    if (rule.type === 'ç¦æ­¢å…¨è¡¨æ‰«æ') {
        return `æŸ¥è¯¢${(rule.tables||[]).join('æˆ–')}æ—¶ç¦æ­¢SELECT *æˆ–æ— WHEREæ¡ä»¶`;
    }
    if (rule.type === 'JOINåˆ†åŒºå­—æ®µ') {
        return `JOIN${(rule.tables||[]).join('æˆ–')}æ—¶ï¼ŒJOINæ¡ä»¶å¿…é¡»åŒ…å«${rule.partition_field||'åˆ†åŒºå­—æ®µ'}`;
    }
    if (rule.type === 'çª—å£å‡½æ•°æ¨è') {
        return `æ¨èä½¿ç”¨çª—å£å‡½æ•°ï¼š${rule.other||''}`;
    }
    if (rule.type === 'CTEæ¨è') {
        return `æ¨èç”¨CTEï¼ˆWITHå­å¥ï¼‰å°è£…ä¸´æ—¶è¡¨`;
    }
    if (rule.type === 'å¤æ‚æŸ¥è¯¢ä¼˜åŒ–') {
        return `å¤æ‚æŸ¥è¯¢æ¨èç”¨ç‰©åŒ–è§†å›¾ã€åˆé€‚JOINã€ç´¢å¼•ç­‰ä¼˜åŒ–`;
    }
    if (rule.type === 'JOINé¡ºåºä¼˜åŒ–') {
        return `å¤šè¡¨JOINæ—¶æ¨èå¤§è¡¨åšå·¦è¡¨ï¼Œå°è¡¨åšHashè¡¨`;
    }
    if (rule.type === 'è¡Œè½¬åˆ—æ¨è') {
        return `æ¨èç”¨Lateral Joinå®ç°è¡Œè½¬åˆ—`;
    }
    if (rule.type === 'åˆ†é¡µä¼˜åŒ–') {
        return `åˆ†é¡µæ¨èç”¨OFFSETæ–¹å¼`;
    }
    if (rule.type === 'è‡ªå®šä¹‰') {
        return rule.other||'è‡ªå®šä¹‰è§„åˆ™';
    }
    return rule.type + (rule.other ? 'ï¼š' + rule.other : '');
}
async function loadRules() {
    rulesListDiv.innerHTML = 'åŠ è½½ä¸­...';
    const res = await fetch('/api/rules');
    const rules = await res.json();
    if (!Array.isArray(rules) || rules.length === 0) {
        rulesListDiv.innerHTML = 'æš‚æ— è§„åˆ™';
        return;
    }
    let html = '<table class="table table-bordered table-sm"><thead><tr><th>#</th><th>ç±»å‹</th><th>è§„åˆ™æè¿°</th><th>æ“ä½œ</th></tr></thead><tbody>';
    rules.forEach((rule, idx) => {
        html += `<tr>
            <td>${idx+1}</td>
            <td>${rule.type||''}</td>
            <td>${ruleToDescription(rule)}</td>
            <td><button class='btn btn-sm btn-danger' onclick='deleteRule(${idx})'>åˆ é™¤</button></td>
        </tr>`;
    });
    html += '</tbody></table>';
    rulesListDiv.innerHTML = html;
}
async function deleteRule(idx) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥è§„åˆ™å—ï¼Ÿ')) return;
    const formData = new FormData();
    formData.append('idx', idx);
    const res = await fetch('/api/rules', {method:'DELETE', body:formData});
    const data = await res.json();
    if (data.success) {
        loadRules();
    } else {
        alert(data.msg||'åˆ é™¤å¤±è´¥');
    }
}
document.getElementById('add-rule-btn').onclick = async function() {
    const rule_type = document.getElementById('rule-type').value;
    const tables = document.getElementById('rule-tables').value;
    const partition_field = document.getElementById('rule-partition').value;
    const forbid_order_by = document.getElementById('rule-forbid-order').value;
    const other = document.getElementById('rule-other').value;
    const formData = new FormData();
    formData.append('rule_type', rule_type);
    formData.append('tables', tables);
    formData.append('partition_field', partition_field);
    formData.append('forbid_order_by', forbid_order_by);
    formData.append('other', other);
    const res = await fetch('/api/rules', {method:'POST', body:formData});
    const data = await res.json();
    if (data.success) {
        loadRules();
        document.getElementById('rule-tables').value = '';
        document.getElementById('rule-partition').value = '';
        document.getElementById('rule-forbid-order').value = '';
        document.getElementById('rule-other').value = '';
    } else {
        alert('æ–°å¢å¤±è´¥');
    }
};
// æ—¶é—´å‹å¥½åŒ–å‡½æ•°
function friendlyTime(isoStr) {
    const t = new Date(isoStr.replace(/-/g,'/'));
    const now = new Date();
    const diff = (now-t)/1000;
    if(diff<60) return 'åˆšåˆš';
    if(diff<3600) return Math.floor(diff/60)+'åˆ†é’Ÿå‰';
    if(diff<86400) return Math.floor(diff/3600)+'å°æ—¶å‰';
    if(diff<2592000) return Math.floor(diff/86400)+'å¤©å‰';
    return isoStr.replace('T',' ').replace(/\..*$/, '');
}
</script>
</body>
</html>